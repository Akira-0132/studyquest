(()=>{var t=[,(t,e,o)=>{var i=o(2);t.exports=function(t,e,o){return(e=i(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t},t.exports.__esModule=!0,t.exports.default=t.exports},(t,e,o)=>{var i=o(3).default,n=o(4);t.exports=function(t){var e=n(t,"string");return"symbol"==i(e)?e:e+""},t.exports.__esModule=!0,t.exports.default=t.exports},t=>{function e(o){return t.exports=e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t.exports.__esModule=!0,t.exports.default=t.exports,e(o)}t.exports=e,t.exports.__esModule=!0,t.exports.default=t.exports},(t,e,o)=>{var i=o(3).default;t.exports=function(t,e){if("object"!=i(t)||!t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var n=o.call(t,e||"default");if("object"!=i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)},t.exports.__esModule=!0,t.exports.default=t.exports}],e={};function o(i){var n=e[i];if(void 0!==n)return n.exports;var a=e[i]={exports:{}};return t[i](a,a.exports,o),a.exports}(()=>{var t=o(1);function e(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,i)}return o}function i(o){for(var i=1;i<arguments.length;i++){var n=null!=arguments[i]?arguments[i]:{};i%2?e(Object(n),!0).forEach(function(e){t(o,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(n)):e(Object(n)).forEach(function(t){Object.defineProperty(o,t,Object.getOwnPropertyDescriptor(n,t))})}return o}console.log("📱 StudyQuest Custom Worker initializing..."),self.addEventListener("push",t=>{const e=Math.random().toString(36).substr(2,9);console.log("📱 Push event received (iOS PWA):",{pushEventId:e,hasData:!!t.data,timestamp:(new Date).toISOString(),origin:self.location.origin});t.waitUntil((async()=>{await(async()=>{try{let t=0;try{const e=await self.clients.matchAll().then(t=>new Promise(e=>{if(t.length>0){const o=new MessageChannel;o.port1.onmessage=t=>{e(t.data.silentPushCount||0)},t[0].postMessage({type:"GET_SILENT_PUSH_COUNT"},[o.port2])}else e(0)}));t=parseInt(e)||0}catch(t){console.warn("⚠️ Could not retrieve silent push count:",t)}console.log(`📊 Current silent push count: ${t}/3`),t>=2&&console.warn(`🚨 HIGH SILENT PUSH COUNT WARNING: ${t}/3 - Subscription at risk!`)}catch(t){console.warn("⚠️ Failed to track push event:",t)}})();let e={title:"StudyQuest",body:"📚 勉強の時間です！",icon:"/icon-192x192.png",badge:"/icon-96x96.png",tag:"studyquest-push",requireInteraction:!0,silent:!1,vibrate:[200,100,200],renotify:!0,data:{timestamp:Date.now(),url:"/",source:"background-push",pushEventId:Math.random().toString(36).substr(2,9)},actions:[{action:"open",title:"アプリを開く",icon:"/icon-96x96.png"},{action:"dismiss",title:"閉じる"}]};if(t.data)try{const o=t.data.json();console.log("📦 Push data received:",o),e=i(i(i({},e),o),{},{silent:!1,data:i(i({},e.data),o.data)})}catch(o){console.warn("⚠️ Push data parsing failed, using text:",o),e.body=t.data.text()||e.body}try{"undefined"==typeof indexedDB&&console.warn("⚠️ IndexedDB unavailable in push context (iOS bug)");const t=await self.registration.showNotification(e.title,{body:e.body,icon:e.icon,badge:e.badge,tag:e.tag,requireInteraction:e.requireInteraction,silent:!1,vibrate:e.vibrate,renotify:e.renotify,data:e.data,actions:e.actions});console.log("✅ iOS PWA notification displayed successfully"),console.log("- Notification tag:",e.tag),console.log("- Silent:",!1),console.log("- RequireInteraction:",e.requireInteraction);try{await self.clients.matchAll().then(t=>{t.forEach(t=>{t.postMessage({type:"NOTIFICATION_DISPLAYED",notification:{title:e.title,body:e.body,tag:e.tag,timestamp:Date.now()}})})})}catch(t){console.warn("⚠️ Failed to notify clients of notification display:",t)}return t}catch(t){console.error("❌ Primary notification display failed:",t);try{const e=await self.registration.showNotification("StudyQuest 通知",{body:"新しい通知があります（フォールバック）",icon:"/icon-192x192.png",badge:"/icon-96x96.png",tag:"ios-fallback-notification",requireInteraction:!0,silent:!1,data:{timestamp:Date.now(),source:"ios-fallback",originalError:t.message}});return console.log("🔄 iOS fallback notification displayed"),e}catch(e){return console.error("💥 CRITICAL: Both primary and fallback notifications failed on iOS!"),console.error("- Primary error:",t),console.error("- Fallback error:",e),await self.registration.showNotification("StudyQuest",{body:"通知エラー - 基本表示",requireInteraction:!0,silent:!1})}}})())}),self.addEventListener("notificationclick",t=>{if(console.log("📱 Notification clicked (iOS PWA):",{action:t.action,tag:t.notification.tag,data:t.notification.data}),t.notification.close(),"dismiss"===t.action)return void console.log("✖️ Notification dismissed");t.waitUntil((async()=>{try{const o=await clients.matchAll({type:"window",includeUncontrolled:!0});console.log("🔍 Found clients:",o.length);for(const e of o)if(e.url.includes(self.location.origin)&&"focus"in e)return console.log("🎯 Focusing existing client"),await e.focus(),void(t.notification.data&&t.notification.data.url&&e.postMessage({type:"NAVIGATE_TO",url:t.notification.data.url}));if(clients.openWindow){var e;const o=(null===(e=t.notification.data)||void 0===e?void 0:e.url)||"/";console.log("🆕 Opening new window:",o),await clients.openWindow(o)}}catch(t){console.error("❌ Failed to handle notification click:",t)}})())}),self.addEventListener("message",async t=>{console.log("📨 Message received in custom worker:",t.data);try{if(t.data&&"SKIP_WAITING"===t.data.type)console.log("⏩ Skipping waiting..."),self.skipWaiting();else if(t.data&&"TEST_NOTIFICATION"===t.data.type)console.log("🧪 Sending test notification..."),await self.registration.showNotification("StudyQuest テスト",{body:t.data.message||"🔔 通知テストです（iOS PWA対応）",icon:"/icon-192x192.png",badge:"/icon-96x96.png",tag:"test-notification",requireInteraction:!0,vibrate:[200,100,200],data:{timestamp:Date.now(),source:"test",url:"/"},actions:[{action:"open",title:"アプリを開く"},{action:"dismiss",title:"閉じる"}]});else if(t.data&&"CHECK_PERMISSION"===t.data.type){const e=self.Notification?self.Notification.permission:"default";console.log("🔔 Permission status:",e),t.ports&&t.ports[0]&&t.ports[0].postMessage({permission:e,pushManagerAvailable:!(!self.registration||!self.registration.pushManager)})}else if(t.data&&"SCHEDULE_NOTIFICATIONS"===t.data.type)console.log("📅 Scheduling notifications:",t.data.settings);else if(t.data&&"IOS_PWA_CHECK"===t.data.type){const e=self.matchMedia&&self.matchMedia("(display-mode: standalone)").matches;console.log("📱 iOS PWA status:",e),t.ports&&t.ports[0]&&t.ports[0].postMessage({isPWA:e,userAgent:self.navigator.userAgent,pushManagerAvailable:!(!self.registration||!self.registration.pushManager)})}}catch(t){console.error("❌ Message handling failed:",t)}}),self.addEventListener("periodicsync",async t=>{console.log("📅 Periodic sync event:",t.tag),"check-notifications"===t.tag&&t.waitUntil(async function(){console.log("⏰ Checking scheduled notifications via server...");try{const t=await fetch("/api/send-scheduled-notifications",{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok)return void console.warn("⚠️ Server scheduled notifications check failed:",t.status);const e=await t.json();e.summary.sent>0&&console.log(`📬 ${e.summary.sent} scheduled notifications sent by server`),e.summary.failed>0&&console.warn(`⚠️ ${e.summary.failed} scheduled notifications failed`)}catch(t){console.error("❌ Server scheduled notification check failed:",t),await async function(){console.log("🔄 Using fallback local notification...");try{const t=(new Date).getHours();let e="📚 勉強の時間です！",o="StudyQuest リマインダー";t<12?(o="StudyQuest 🌅 おはよう！",e="新しい一日の始まりです！今日も頑張りましょう！"):t<18?(o="StudyQuest 📚 午後の学習",e="学校お疲れさま！集中して勉強しましょう！"):(o="StudyQuest 🌙 夜の学習",e="ラストスパート！今日の目標を達成しよう！"),await self.registration.showNotification(o,{body:e,icon:"/icon-192x192.png",badge:"/icon-96x96.png",tag:"fallback-scheduled-notification",requireInteraction:!0,vibrate:[200,100,200],data:{timestamp:Date.now(),source:"fallback-scheduled",url:"/"},actions:[{action:"open",title:"勉強を始める"},{action:"dismiss",title:"後で"}]}),console.log("✅ Fallback scheduled notification shown")}catch(t){console.error("❌ Fallback notification failed:",t)}}()}}())}),self.addEventListener("sync",async t=>{console.log("🔄 Sync event:",t.tag),"send-notification"===t.tag?t.waitUntil(async function(){console.log("📤 Sending pending notifications...");try{console.log("✅ Pending notifications processed")}catch(t){console.error("❌ Failed to send pending notifications:",t)}}()):"ios-notification-retry"===t.tag&&t.waitUntil(async function(){console.log("🔄 Retrying failed notifications (iOS specific)...");try{console.log("✅ Retry process completed")}catch(t){console.error("❌ Notification retry failed:",t)}}())}),console.log("📱 iOS PWA Custom Worker loaded successfully"),self.addEventListener("error",t=>{console.error("🚨 Custom Worker error (iOS):",t.error)}),self.addEventListener("unhandledrejection",t=>{console.error("🚨 Custom Worker unhandled promise rejection (iOS):",t.reason)})})()})();