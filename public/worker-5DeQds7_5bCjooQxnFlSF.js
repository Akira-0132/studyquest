(()=>{var t=[,(t,e,o)=>{var i=o(2);t.exports=function(t,e,o){return(e=i(e))in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t},t.exports.__esModule=!0,t.exports.default=t.exports},(t,e,o)=>{var i=o(3).default,n=o(4);t.exports=function(t){var e=n(t,"string");return"symbol"==i(e)?e:e+""},t.exports.__esModule=!0,t.exports.default=t.exports},t=>{function e(o){return t.exports=e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t.exports.__esModule=!0,t.exports.default=t.exports,e(o)}t.exports=e,t.exports.__esModule=!0,t.exports.default=t.exports},(t,e,o)=>{var i=o(3).default;t.exports=function(t,e){if("object"!=i(t)||!t)return t;var o=t[Symbol.toPrimitive];if(void 0!==o){var n=o.call(t,e||"default");if("object"!=i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)},t.exports.__esModule=!0,t.exports.default=t.exports}],e={};function o(i){var n=e[i];if(void 0!==n)return n.exports;var a=e[i]={exports:{}};return t[i](a,a.exports,o),a.exports}(()=>{var t=o(1);function e(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),o.push.apply(o,i)}return o}function i(o){for(var i=1;i<arguments.length;i++){var n=null!=arguments[i]?arguments[i]:{};i%2?e(Object(n),!0).forEach(function(e){t(o,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(n)):e(Object(n)).forEach(function(t){Object.defineProperty(o,t,Object.getOwnPropertyDescriptor(n,t))})}return o}console.log("ğŸ“± StudyQuest Custom Worker initializing..."),self.addEventListener("push",t=>{const e=Math.random().toString(36).substr(2,9);console.log("ğŸ“± Push event received (iOS PWA):",{pushEventId:e,hasData:!!t.data,timestamp:(new Date).toISOString(),origin:self.location.origin});t.waitUntil((async()=>{await(async()=>{try{let t=0;try{const e=await self.clients.matchAll().then(t=>new Promise(e=>{if(t.length>0){const o=new MessageChannel;o.port1.onmessage=t=>{e(t.data.silentPushCount||0)},t[0].postMessage({type:"GET_SILENT_PUSH_COUNT"},[o.port2])}else e(0)}));t=parseInt(e)||0}catch(t){console.warn("âš ï¸ Could not retrieve silent push count:",t)}console.log(`ğŸ“Š Current silent push count: ${t}/3`),t>=2&&console.warn(`ğŸš¨ HIGH SILENT PUSH COUNT WARNING: ${t}/3 - Subscription at risk!`)}catch(t){console.warn("âš ï¸ Failed to track push event:",t)}})();let e={title:"StudyQuest",body:"ğŸ“š å‹‰å¼·ã®æ™‚é–“ã§ã™ï¼",icon:"/icon-192x192.png",badge:"/icon-96x96.png",tag:"studyquest-push",requireInteraction:!0,silent:!1,vibrate:[200,100,200],renotify:!0,data:{timestamp:Date.now(),url:"/",source:"background-push",pushEventId:Math.random().toString(36).substr(2,9)},actions:[{action:"open",title:"ã‚¢ãƒ—ãƒªã‚’é–‹ã",icon:"/icon-96x96.png"},{action:"dismiss",title:"é–‰ã˜ã‚‹"}]};if(t.data)try{const o=t.data.json();console.log("ğŸ“¦ Push data received:",o),e=i(i(i({},e),o),{},{silent:!1,data:i(i({},e.data),o.data)})}catch(o){console.warn("âš ï¸ Push data parsing failed, using text:",o),e.body=t.data.text()||e.body}try{"undefined"==typeof indexedDB&&console.warn("âš ï¸ IndexedDB unavailable in push context (iOS bug)");const t=await self.registration.showNotification(e.title,{body:e.body,icon:e.icon,badge:e.badge,tag:e.tag,requireInteraction:e.requireInteraction,silent:!1,vibrate:e.vibrate,renotify:e.renotify,data:e.data,actions:e.actions});console.log("âœ… iOS PWA notification displayed successfully"),console.log("- Notification tag:",e.tag),console.log("- Silent:",!1),console.log("- RequireInteraction:",e.requireInteraction);try{await self.clients.matchAll().then(t=>{t.forEach(t=>{t.postMessage({type:"NOTIFICATION_DISPLAYED",notification:{title:e.title,body:e.body,tag:e.tag,timestamp:Date.now()}})})})}catch(t){console.warn("âš ï¸ Failed to notify clients of notification display:",t)}return t}catch(t){console.error("âŒ Primary notification display failed:",t);try{const e=await self.registration.showNotification("StudyQuest é€šçŸ¥",{body:"æ–°ã—ã„é€šçŸ¥ãŒã‚ã‚Šã¾ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰",icon:"/icon-192x192.png",badge:"/icon-96x96.png",tag:"ios-fallback-notification",requireInteraction:!0,silent:!1,data:{timestamp:Date.now(),source:"ios-fallback",originalError:t.message}});return console.log("ğŸ”„ iOS fallback notification displayed"),e}catch(e){return console.error("ğŸ’¥ CRITICAL: Both primary and fallback notifications failed on iOS!"),console.error("- Primary error:",t),console.error("- Fallback error:",e),await self.registration.showNotification("StudyQuest",{body:"é€šçŸ¥ã‚¨ãƒ©ãƒ¼ - åŸºæœ¬è¡¨ç¤º",requireInteraction:!0,silent:!1})}}})())}),self.addEventListener("notificationclick",t=>{if(console.log("ğŸ“± Notification clicked (iOS PWA):",{action:t.action,tag:t.notification.tag,data:t.notification.data}),t.notification.close(),"dismiss"===t.action)return void console.log("âœ–ï¸ Notification dismissed");t.waitUntil((async()=>{try{const o=await clients.matchAll({type:"window",includeUncontrolled:!0});console.log("ğŸ” Found clients:",o.length);for(const e of o)if(e.url.includes(self.location.origin)&&"focus"in e)return console.log("ğŸ¯ Focusing existing client"),await e.focus(),void(t.notification.data&&t.notification.data.url&&e.postMessage({type:"NAVIGATE_TO",url:t.notification.data.url}));if(clients.openWindow){var e;const o=(null===(e=t.notification.data)||void 0===e?void 0:e.url)||"/";console.log("ğŸ†• Opening new window:",o),await clients.openWindow(o)}}catch(t){console.error("âŒ Failed to handle notification click:",t)}})())}),self.addEventListener("message",async t=>{console.log("ğŸ“¨ Message received in custom worker:",t.data);try{if(t.data&&"SKIP_WAITING"===t.data.type)console.log("â© Skipping waiting..."),self.skipWaiting();else if(t.data&&"TEST_NOTIFICATION"===t.data.type)console.log("ğŸ§ª Sending test notification..."),await self.registration.showNotification("StudyQuest ãƒ†ã‚¹ãƒˆ",{body:t.data.message||"ğŸ”” é€šçŸ¥ãƒ†ã‚¹ãƒˆã§ã™ï¼ˆiOS PWAå¯¾å¿œï¼‰",icon:"/icon-192x192.png",badge:"/icon-96x96.png",tag:"test-notification",requireInteraction:!0,vibrate:[200,100,200],data:{timestamp:Date.now(),source:"test",url:"/"},actions:[{action:"open",title:"ã‚¢ãƒ—ãƒªã‚’é–‹ã"},{action:"dismiss",title:"é–‰ã˜ã‚‹"}]});else if(t.data&&"CHECK_PERMISSION"===t.data.type){const e=self.Notification?self.Notification.permission:"default";console.log("ğŸ”” Permission status:",e),t.ports&&t.ports[0]&&t.ports[0].postMessage({permission:e,pushManagerAvailable:!(!self.registration||!self.registration.pushManager)})}else if(t.data&&"SCHEDULE_NOTIFICATIONS"===t.data.type)console.log("ğŸ“… Scheduling notifications:",t.data.settings);else if(t.data&&"IOS_PWA_CHECK"===t.data.type){const e=self.matchMedia&&self.matchMedia("(display-mode: standalone)").matches;console.log("ğŸ“± iOS PWA status:",e),t.ports&&t.ports[0]&&t.ports[0].postMessage({isPWA:e,userAgent:self.navigator.userAgent,pushManagerAvailable:!(!self.registration||!self.registration.pushManager)})}}catch(t){console.error("âŒ Message handling failed:",t)}}),self.addEventListener("periodicsync",async t=>{console.log("ğŸ“… Periodic sync event:",t.tag),"check-notifications"===t.tag&&t.waitUntil(async function(){console.log("â° Checking scheduled notifications via server...");try{const t=await fetch("/api/send-scheduled-notifications",{method:"POST",headers:{"Content-Type":"application/json"}});if(!t.ok)return void console.warn("âš ï¸ Server scheduled notifications check failed:",t.status);const e=await t.json();e.summary.sent>0&&console.log(`ğŸ“¬ ${e.summary.sent} scheduled notifications sent by server`),e.summary.failed>0&&console.warn(`âš ï¸ ${e.summary.failed} scheduled notifications failed`)}catch(t){console.error("âŒ Server scheduled notification check failed:",t),await async function(){console.log("ğŸ”„ Using fallback local notification...");try{const t=(new Date).getHours();let e="ğŸ“š å‹‰å¼·ã®æ™‚é–“ã§ã™ï¼",o="StudyQuest ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼";t<12?(o="StudyQuest ğŸŒ… ãŠã¯ã‚ˆã†ï¼",e="æ–°ã—ã„ä¸€æ—¥ã®å§‹ã¾ã‚Šã§ã™ï¼ä»Šæ—¥ã‚‚é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼"):t<18?(o="StudyQuest ğŸ“š åˆå¾Œã®å­¦ç¿’",e="å­¦æ ¡ãŠç–²ã‚Œã•ã¾ï¼é›†ä¸­ã—ã¦å‹‰å¼·ã—ã¾ã—ã‚‡ã†ï¼"):(o="StudyQuest ğŸŒ™ å¤œã®å­¦ç¿’",e="ãƒ©ã‚¹ãƒˆã‚¹ãƒ‘ãƒ¼ãƒˆï¼ä»Šæ—¥ã®ç›®æ¨™ã‚’é”æˆã—ã‚ˆã†ï¼"),await self.registration.showNotification(o,{body:e,icon:"/icon-192x192.png",badge:"/icon-96x96.png",tag:"fallback-scheduled-notification",requireInteraction:!0,vibrate:[200,100,200],data:{timestamp:Date.now(),source:"fallback-scheduled",url:"/"},actions:[{action:"open",title:"å‹‰å¼·ã‚’å§‹ã‚ã‚‹"},{action:"dismiss",title:"å¾Œã§"}]}),console.log("âœ… Fallback scheduled notification shown")}catch(t){console.error("âŒ Fallback notification failed:",t)}}()}}())}),self.addEventListener("sync",async t=>{console.log("ğŸ”„ Sync event:",t.tag),"send-notification"===t.tag?t.waitUntil(async function(){console.log("ğŸ“¤ Sending pending notifications...");try{console.log("âœ… Pending notifications processed")}catch(t){console.error("âŒ Failed to send pending notifications:",t)}}()):"ios-notification-retry"===t.tag&&t.waitUntil(async function(){console.log("ğŸ”„ Retrying failed notifications (iOS specific)...");try{console.log("âœ… Retry process completed")}catch(t){console.error("âŒ Notification retry failed:",t)}}())}),console.log("ğŸ“± iOS PWA Custom Worker loaded successfully"),self.addEventListener("error",t=>{console.error("ğŸš¨ Custom Worker error (iOS):",t.error)}),self.addEventListener("unhandledrejection",t=>{console.error("ğŸš¨ Custom Worker unhandled promise rejection (iOS):",t.reason)})})()})();